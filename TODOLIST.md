# TODOLIST: Улучшение системного агента Юрист

**Дата начала:** 2026-02-26
**Статус:** Завершено

---

## Фаза 1: Ингест Z и S типов законов в FragmentDB

### Задачи
- [x] 1.1 Dry-run тест: `python3 scripts/ingestion/ingest_adilet.py --types Z,S --dry-run`
- [x] 1.2 Запуск ингеста Z-type (3,519 законов): `--types Z --resume`
- [x] 1.3 Запуск ингеста S-type (270 конституционных законов): `--types S --resume`
- [x] 1.4 Проверка BM25 индекс перестроен после ингеста

### Тестирование Фазы 1
- [x] T1.1 Проверить количество Z-type документов в FragmentDB
- [x] T1.2 Проверить количество S-type документов
- [x] T1.3 Тест get_law для известного Z-type закона
- [x] T1.4 Тест get_law для S-type
- [x] T1.5 Тест search по laws_kz
- [x] T1.6 Проверить общее количество документов: ~199K

---

## Фаза 2: Исправление parseLawResponse (баг с ошибкой как текст)

### Задачи
- [x] 2.1 Исправить `parseLawResponse` в `src/app/api/articles/route.ts` — детектить `parsed.error`, возвращать 404 с `adiletUrl`
- [x] 2.2 Добавить `adiletUrl` в успешные ответы (из `parsed.url` или по шаблону)
- [x] 2.3 Исправить `parseArticleResponse` аналогично (консистентность)

### Тестирование Фазы 2
- [x] T2.1 Тест ошибки: `GET /api/articles?code=law&article=ZNONEXISTENT` — 404 с adiletUrl
- [x] T2.2 Тест успеха: `GET /api/articles?code=law&article=Z120000434_` — 200 с adiletUrl
- [x] T2.3 Тест ошибки для кодексов: `GET /api/articles?code=criminal_code&article=99999` — 404
- [x] T2.4 Тест парсинга: raw JSON `{"error":"..."}` никогда не показывается как текст
- [x] T2.5 Сборка проекта: `npm run build` — без ошибок

---

## Фаза 3: Улучшение UX ошибки в ArticleContentView

### Задачи
- [x] 3.1 Добавить fallback ссылку на adilet.zan.kz в компонент `ArticleError`
- [x] 3.2 Показывать текст "Документ может быть ещё не загружен в базу" + ссылка на adilet
- [x] 3.3 Ссылка только для `code === "law"` (для кодексов adilet не нужен)

### Тестирование Фазы 3
- [x] T3.1 Клик по ссылке article://law/ZNONEXISTENT — ошибка + ссылка на adilet
- [x] T3.2 Клик по ссылке article://criminal_code/188 — нормально открывается
- [x] T3.3 Клик по ссылке article://criminal_code/99999 — ошибка БЕЗ ссылки на adilet
- [x] T3.4 Кнопка "Повторить" работает
- [x] T3.5 Ссылка на adilet.zan.kz открывается в новой вкладке
- [x] T3.6 Мобильный вид: ошибка отображается корректно
- [x] T3.7 Сборка: `npm run build` — без ошибок

---

## Фаза 4: Улучшение промпта юриста (FEMIDA_SYSTEM_PROMPT)

### Задачи
- [x] 4.1 Добавить критическое правило: doc_code ТОЛЬКО из результатов search()
- [x] 4.2 Добавить пошаговый алгоритм: search → doc_code из результатов → get_law
- [x] 4.3 Добавить запрет: "НЕ выдумывай doc_code" + "НЕ выдумывай ссылки article://law/"
- [x] 4.4 Добавить раздел "СТРУКТУРА ОТВЕТА"
- [x] 4.5 Обновить описание get_law: подчеркнуть источник doc_code
- [x] 4.6 Запустить seed: `npx prisma db seed`

### Тестирование Фазы 4
- [x] T4.1–T4.6 Проверки формата, ссылок, seed — пройдены

---

## Фаза 5: Улучшение ответа ошибки в оркестраторе

### Задачи
- [x] 5.1 Обогатить ответ ошибки в `_handle_get_law`: url, doc_code, suggestion
- [x] 5.2 Рестарт оркестратора после изменений

### Тестирование Фазы 5
- [x] T5.1 Прямой вызов MCP: get_law с несуществующим doc_code — ответ содержит url + suggestion
- [x] T5.2 Через чат: AI предоставляет ссылку на adilet
- [x] T5.3 Оркестратор стабилен после рестарта

---

## Фаза 6: Обновление глобального промпта

### Задачи
- [x] 6.1 Добавить предупреждение в `src/lib/prompts.ts`: doc_code только из search
- [x] 6.2 Запустить seed

### Тестирование Фазы 6
- [x] T6.1 Сборка: `npm run build` — без ошибок
- [x] T6.2 Чат с любым агентом: ссылки article:// формируются корректно

---

## Финальная проверка (после всех фаз)

### Сквозные сценарии
- [x] F1–F8 Все сквозные сценарии пройдены

### Деплой
- [x] D1 `./scripts/deploy.sh app` — пересборка контейнеров приложения
- [x] D2 Рестарт оркестратора
- [x] D3 Health check: `GET /api/health` — 200 OK
- [x] D4 Smoke test в продакшене

---

## Прогресс

| Фаза | Статус | Дата завершения |
|------|--------|----------------|
| 1. Ингест Z/S | ✅ Завершено | 2026-02-26 |
| 2. parseLawResponse fix | ✅ Завершено | 2026-02-26 |
| 3. ArticleContentView UX | ✅ Завершено | 2026-02-26 |
| 4. Промпт юриста | ✅ Завершено | 2026-02-26 |
| 5. Оркестратор error | ✅ Завершено | 2026-02-26 |
| 6. Глобальный промпт | ✅ Завершено | 2026-02-26 |
| Финальная проверка | ✅ Завершено | 2026-02-27 |
| Деплой | ✅ Завершено | 2026-02-27 |
