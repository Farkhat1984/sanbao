# TODOLIST: Улучшение системного агента Юрист

**Дата начала:** 2026-02-26
**Статус:** В работе

---

## Фаза 1: Ингест Z и S типов законов в FragmentDB

### Задачи
- [ ] 1.1 Dry-run тест: `python3 scripts/ingestion/ingest_adilet.py --types Z,S --dry-run`
- [ ] 1.2 Запуск ингеста Z-type (3,519 законов): `--types Z --resume`
- [ ] 1.3 Запуск ингеста S-type (270 конституционных законов): `--types S --resume`
- [ ] 1.4 Проверка BM25 индекс перестроен после ингеста

### Тестирование Фазы 1
- [ ] T1.1 Проверить количество Z-type документов в FragmentDB: `meta_scan(filter_field="doc_type", filter_value="Z")` — ожидаем > 3,000
- [ ] T1.2 Проверить количество S-type документов: `meta_scan(filter_field="doc_type", filter_value="S")` — ожидаем > 200
- [ ] T1.3 Тест get_law для известного Z-type закона: `get_law(doc_code="Z120000434_")` — должен вернуть полный текст
- [ ] T1.4 Тест get_law для S-type: `get_law(doc_code="S000000001_")` — должен вернуть текст
- [ ] T1.5 Тест search по laws_kz: `search(query="закон о государственных закупках", domain="laws_kz")` — должен находить Z-type результаты
- [ ] T1.6 Проверить общее количество документов: `curl http://localhost:8110/collections/laws_kz` — doc_count должен вырасти

---

## Фаза 2: Исправление parseLawResponse (баг с ошибкой как текст)

### Задачи
- [ ] 2.1 Исправить `parseLawResponse` в `src/app/api/articles/route.ts` — детектить `parsed.error`, возвращать 404 с `adiletUrl`
- [ ] 2.2 Добавить `adiletUrl` в успешные ответы (из `parsed.url` или по шаблону)
- [ ] 2.3 Исправить `parseArticleResponse` аналогично (консистентность)

### Тестирование Фазы 2
- [ ] T2.1 Тест ошибки: `GET /api/articles?code=law&article=ZNONEXISTENT` — должен вернуть `{ error: "...", adiletUrl: "..." }` со статусом 404
- [ ] T2.2 Тест успеха: `GET /api/articles?code=law&article=Z120000434_` — должен вернуть `{ code, article, title, text, adiletUrl }`
- [ ] T2.3 Тест ошибки для кодексов: `GET /api/articles?code=criminal_code&article=99999` — должен вернуть 404 а не JSON-строку как текст
- [ ] T2.4 Тест парсинга: проверить что raw JSON `{"error":"..."}` НИКОГДА не показывается как текст статьи
- [ ] T2.5 Сборка проекта: `npm run build` — без ошибок

---

## Фаза 3: Улучшение UX ошибки в ArticleContentView

### Задачи
- [ ] 3.1 Добавить fallback ссылку на adilet.zan.kz в компонент `ArticleError` (`src/components/panel/ArticleContentView.tsx`)
- [ ] 3.2 Показывать текст "Документ может быть ещё не загружен в базу" + ссылка на adilet
- [ ] 3.3 Ссылка только для `code === "law"` (для кодексов adilet не нужен)

### Тестирование Фазы 3
- [ ] T3.1 Клик по ссылке `article://law/ZNONEXISTENT` в чате — панель должна показать ошибку + ссылку на adilet.zan.kz
- [ ] T3.2 Клик по ссылке `article://criminal_code/188` — должна нормально открыться статья (без ссылки на adilet)
- [ ] T3.3 Клик по ссылке `article://criminal_code/99999` — ошибка БЕЗ ссылки на adilet (это кодекс, не закон)
- [ ] T3.4 Кнопка "Повторить" — должна работать после ошибки
- [ ] T3.5 Ссылка на adilet.zan.kz — должна открываться в новой вкладке
- [ ] T3.6 Мобильный вид: проверить что ошибка нормально отображается на маленьком экране
- [ ] T3.7 Сборка: `npm run build` — без ошибок

---

## Фаза 4: Улучшение промпта юриста (FEMIDA_SYSTEM_PROMPT)

### Задачи
- [ ] 4.1 Добавить критическое правило: doc_code ТОЛЬКО из результатов search()
- [ ] 4.2 Добавить пошаговый алгоритм: search → doc_code из результатов → get_law
- [ ] 4.3 Добавить запрет: "НЕ выдумывай doc_code" + "НЕ выдумывай ссылки article://law/"
- [ ] 4.4 Добавить раздел "СТРУКТУРА ОТВЕТА" — не дампить весь закон, цитировать конкретные статьи
- [ ] 4.5 Обновить описание get_law: подчеркнуть источник doc_code
- [ ] 4.6 Запустить seed: `npx prisma db seed` для обновления промпта в БД

### Тестирование Фазы 4
- [ ] T4.1 Чат с юристом: "Закон Z990001360_" — должен сначала search, а НЕ сразу get_law с выдуманным кодом
- [ ] T4.2 Чат: "Какой закон регулирует государственные закупки?" — должен search → взять doc_code из результатов → get_law
- [ ] T4.3 Чат: "Расскажи про статью 188 УК РК" — должен вызвать get_article, а не search по laws_kz
- [ ] T4.4 Проверить формат ответа: ссылки article:// должны содержать РЕАЛЬНЫЕ doc_code из search
- [ ] T4.5 Проверить структуру: ответ содержит конкретные статьи, а не полный текст закона
- [ ] T4.6 Проверить что seed прошёл: промпт обновлён в таблице Agent

---

## Фаза 5: Улучшение ответа ошибки в оркестраторе

### Задачи
- [ ] 5.1 Обогатить ответ ошибки в `_handle_get_law` (`ai_cortex/orchestrator/mcp_server.py`): добавить url, doc_code, suggestion
- [ ] 5.2 Рестарт оркестратора после изменений

### Тестирование Фазы 5
- [ ] T5.1 Прямой вызов MCP: get_law с несуществующим doc_code — ответ должен содержать url на adilet и suggestion
- [ ] T5.2 Через чат: спросить о несуществующем законе — AI должен предоставить ссылку на adilet
- [ ] T5.3 Проверить что оркестратор стабилен после рестарта: `curl http://localhost:8120/lawyer` — MCP endpoint доступен

---

## Фаза 6: Обновление глобального промпта

### Задачи
- [ ] 6.1 Добавить предупреждение в `src/lib/prompts.ts` секция "Законы и НПА": doc_code только из search
- [ ] 6.2 Запустить seed если изменения затрагивают seed.ts

### Тестирование Фазы 6
- [ ] T6.1 Сборка: `npm run build` — без ошибок
- [ ] T6.2 Чат с любым агентом: проверить что ссылки article:// формируются корректно

---

## Финальная проверка (после всех фаз)

### Сквозные сценарии
- [ ] F1 Чат с юристом: "Что говорит статья 188 УК РК?" → article://criminal_code/188 → клик → панель показывает текст статьи
- [ ] F2 Чат: "Какой закон о госзакупках?" → search → get_law с реальным doc_code → article://law/... → клик → панель показывает закон
- [ ] F3 Чат: "Закон Z990001360_" → AI ищет через search, НЕ выдумывает doc_code → корректный ответ
- [ ] F4 Ошибка: несуществующий doc_code → панель показывает ошибку + ссылка на adilet.zan.kz
- [ ] F5 Структура: ответ юриста содержит конкретные статьи, а не весь текст закона
- [ ] F6 Мобильная версия: все сценарии F1-F5 работают на мобильном
- [ ] F7 Билд: `npm run build` — без ошибок
- [ ] F8 Линт: `npm run lint` — без ошибок

### Деплой
- [ ] D1 `./scripts/deploy.sh app` — пересборка контейнеров приложения
- [ ] D2 Рестарт оркестратора (если были изменения в Фазе 5)
- [ ] D3 Health check: `GET /api/health` — 200 OK
- [ ] D4 Smoke test в продакшене: проверить сценарии F1-F3

---

## Прогресс

| Фаза | Статус | Дата завершения |
|------|--------|----------------|
| 1. Ингест Z/S | ⬜ Не начато | |
| 2. parseLawResponse fix | ⬜ Не начато | |
| 3. ArticleContentView UX | ⬜ Не начато | |
| 4. Промпт юриста | ⬜ Не начато | |
| 5. Оркестратор error | ⬜ Не начато | |
| 6. Глобальный промпт | ⬜ Не начато | |
| Финальная проверка | ⬜ Не начато | |
| Деплой | ⬜ Не начато | |
