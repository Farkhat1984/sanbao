name: Deploy to Servers

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-server1:
    name: Deploy Sanbao → Server 1 (Primary)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: 128.127.102.170
          port: 22222
          username: metadmin
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          timeout: 600s
          script: |
            set -e
            echo "=== Pulling latest code ==="
            cd ~/faragj/sanbao
            git fetch origin main
            git reset --hard origin/main

            echo "=== Rebuilding sanbao container ==="
            docker compose build --no-cache app
            docker compose up -d app

            echo "=== Waiting for health check ==="
            for i in $(seq 1 30); do
              if curl -sf http://localhost:3004/api/health >/dev/null 2>&1; then
                echo "Sanbao is healthy!"
                exit 0
              fi
              echo "Waiting... ($i/30)"
              sleep 5
            done
            echo "Health check failed!"
            docker compose logs --tail=50 app
            exit 1

  deploy-server2:
    name: Deploy Sanbao → Server 2 (Standby)
    runs-on: ubuntu-latest
    needs: deploy-server1
    timeout-minutes: 15
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: 46.225.122.142
          username: faragj
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          timeout: 600s
          script: |
            set -e
            echo "=== Pulling latest code ==="
            cd ~/faragj/sanbao
            git fetch origin main
            git reset --hard origin/main

            echo "=== Rebuilding Docker image (for failover) ==="
            cd ~/faragj/deploy
            docker compose -f docker-compose.failover.yml build sanbao

            echo "=== Server 2 image updated ==="

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-server1, deploy-server2]
    if: always()
    steps:
      - name: Telegram notification
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          format: html
          message: |
            ${{ needs.deploy-server1.result == 'success' && needs.deploy-server2.result == 'success' && '✅' || '❌' }} <b>Sanbao Deploy</b>

            Server 1: ${{ needs.deploy-server1.result }}
            Server 2: ${{ needs.deploy-server2.result }}
            Commit: <code>${{ github.sha }}</code>
            By: ${{ github.actor }}
