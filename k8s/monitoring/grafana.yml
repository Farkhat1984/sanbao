apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: monitoring
data:
  datasources.yml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-provider
  namespace: monitoring
data:
  dashboards.yml: |
    apiVersion: 1
    providers:
      - name: default
        orgId: 1
        folder: Sanbao
        type: file
        options:
          path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-sanbao
  namespace: monitoring
data:
  sanbao.json: |
    {
      "annotations": { "list": [] },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "links": [],
      "panels": [
        {
          "title": "Active Users Today",
          "type": "stat",
          "gridPos": { "h": 4, "w": 4, "x": 0, "y": 0 },
          "targets": [{ "expr": "sanbao_active_users_today", "legendFormat": "" }],
          "fieldConfig": { "defaults": { "thresholds": { "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 500 }, { "color": "red", "value": 2000 }] } } }
        },
        {
          "title": "Messages Today",
          "type": "stat",
          "gridPos": { "h": 4, "w": 4, "x": 4, "y": 0 },
          "targets": [{ "expr": "sanbao_messages_today", "legendFormat": "" }]
        },
        {
          "title": "Tokens Today",
          "type": "stat",
          "gridPos": { "h": 4, "w": 4, "x": 8, "y": 0 },
          "targets": [{ "expr": "sanbao_tokens_today", "legendFormat": "" }]
        },
        {
          "title": "Errors (1h)",
          "type": "stat",
          "gridPos": { "h": 4, "w": 4, "x": 12, "y": 0 },
          "targets": [{ "expr": "sanbao_errors_1h", "legendFormat": "" }],
          "fieldConfig": { "defaults": { "thresholds": { "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 10 }, { "color": "red", "value": 50 }] } } }
        },
        {
          "title": "Redis Status",
          "type": "stat",
          "gridPos": { "h": 4, "w": 4, "x": 16, "y": 0 },
          "targets": [{ "expr": "sanbao_redis_connected", "legendFormat": "" }],
          "fieldConfig": { "defaults": { "mappings": [{ "type": "value", "options": { "0": { "text": "DOWN", "color": "red" }, "1": { "text": "UP", "color": "green" } } }] } }
        },
        {
          "title": "Uptime",
          "type": "stat",
          "gridPos": { "h": 4, "w": 4, "x": 20, "y": 0 },
          "targets": [{ "expr": "process_uptime_seconds", "legendFormat": "" }],
          "fieldConfig": { "defaults": { "unit": "s" } }
        },
        {
          "title": "Heap Memory",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 4 },
          "targets": [
            { "expr": "process_heap_bytes{type=\"used\"}", "legendFormat": "Heap Used" },
            { "expr": "process_heap_bytes{type=\"rss\"}", "legendFormat": "RSS" },
            { "expr": "process_heap_bytes{type=\"total\"}", "legendFormat": "Heap Total" }
          ],
          "fieldConfig": { "defaults": { "unit": "bytes" } }
        },
        {
          "title": "Request Duration (p50 / p95 / p99)",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 4 },
          "targets": [
            { "expr": "histogram_quantile(0.50, rate(sanbao_request_duration_ms_bucket[5m]))", "legendFormat": "p50" },
            { "expr": "histogram_quantile(0.95, rate(sanbao_request_duration_ms_bucket[5m]))", "legendFormat": "p95" },
            { "expr": "histogram_quantile(0.99, rate(sanbao_request_duration_ms_bucket[5m]))", "legendFormat": "p99" }
          ],
          "fieldConfig": { "defaults": { "unit": "ms" } }
        },
        {
          "title": "Requests per Provider",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 12 },
          "targets": [{ "expr": "rate(sanbao_provider_requests_total[5m])", "legendFormat": "{{ provider }}" }]
        },
        {
          "title": "Cost per Provider",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 12 },
          "targets": [{ "expr": "increase(sanbao_provider_cost_total[1h])", "legendFormat": "{{ provider }}" }],
          "fieldConfig": { "defaults": { "unit": "currencyUSD" } }
        },
        {
          "title": "Redis Memory",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 20 },
          "targets": [{ "expr": "sanbao_redis_memory_bytes", "legendFormat": "Used Memory" }],
          "fieldConfig": { "defaults": { "unit": "bytes" } }
        },
        {
          "title": "Redis Keys",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 20 },
          "targets": [{ "expr": "sanbao_redis_keys", "legendFormat": "Total Keys" }]
        }
      ],
      "schemaVersion": 39,
      "tags": ["sanbao"],
      "templating": { "list": [] },
      "time": { "from": "now-6h", "to": "now" },
      "title": "Sanbao Overview",
      "uid": "sanbao-overview"
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
        - name: grafana
          image: grafana/grafana:11.5.2
          ports:
            - containerPort: 3000
          env:
            - name: GF_SECURITY_ADMIN_PASSWORD
              value: "admin"  # Change in production via secret
            - name: GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH
              value: /var/lib/grafana/dashboards/sanbao.json
          volumeMounts:
            - name: datasources
              mountPath: /etc/grafana/provisioning/datasources
            - name: dashboards-provider
              mountPath: /etc/grafana/provisioning/dashboards
            - name: dashboard-sanbao
              mountPath: /var/lib/grafana/dashboards
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
      volumes:
        - name: datasources
          configMap:
            name: grafana-datasources
        - name: dashboards-provider
          configMap:
            name: grafana-dashboards-provider
        - name: dashboard-sanbao
          configMap:
            name: grafana-dashboard-sanbao
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: monitoring
spec:
  selector:
    app: grafana
  ports:
    - port: 3000
      targetPort: 3000
