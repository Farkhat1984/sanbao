generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// ─── NextAuth models ─────────────────────────────────────

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── App models ──────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?   @db.Text
  password      String?
  role          UserRole  @default(USER)
  isBanned      Boolean   @default(false)
  bannedAt      DateTime?
  bannedReason       String?
  locale             String   @default("ru")
  twoFactorSecret    String?
  twoFactorEnabled   Boolean  @default(false)

  accounts      Account[]
  sessions      Session[]
  conversations Conversation[]
  subscription  Subscription?
  dailyUsage    DailyUsage[]
  agents        Agent[]
  skills        Skill[]
  tasks         Task[]
  memories      UserMemory[]
  mcpServers    McpServer[]
  userMcpLinks  UserMcpServer[]
  tokenLogs     TokenLog[]
  notifications Notification[]
  apiKeys       ApiKey[]
  payments      Payment[]
  fileUploads   FileUpload[]
  tools         Tool[]
  plugins       Plugin[]
  userFiles     UserFile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Conversation {
  id            String  @id @default(cuid())
  title         String  @default("Новый чат")
  userId        String
  pinned        Boolean @default(false)
  archived      Boolean @default(false)
  agentId       String?
  systemAgentId String?

  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent       Agent?                @relation(fields: [agentId], references: [id], onDelete: SetNull)
  messages    Message[]
  artifacts   Artifact[]
  attachments Attachment[]
  summary     ConversationSummary?
  plans       ConversationPlan[]
  tasks       Task[]
  scratchpads Scratchpad[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, updatedAt])
  @@index([userId, archived, updatedAt])
  @@index([agentId])
}

model Message {
  id             String      @id @default(cuid())
  conversationId String
  role           MessageRole
  content        String      @db.Text
  toolName       String?
  toolResult     Json?
  planContent    String?     @db.Text

  conversation Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  legalRefs    LegalReference[]
  artifacts    Artifact[]
  plans        ConversationPlan[]

  createdAt DateTime @default(now())

  @@index([conversationId, createdAt])
  @@index([toolName])
}

model Artifact {
  id             String       @id @default(cuid())
  conversationId String
  messageId      String?
  type           ArtifactType
  title          String
  content        String       @db.Text
  version        Int          @default(1)
  metadata       Json?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  message      Message?     @relation(fields: [messageId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId])
  @@index([type])
}

model LegalReference {
  id           String  @id @default(cuid())
  messageId    String
  articleCode  String
  articleTitle String
  articleText  String  @db.Text
  sourceUrl    String?
  isActual     Boolean @default(true)

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([articleCode])
}

model Attachment {
  id             String @id @default(cuid())
  conversationId String
  fileName       String
  fileType       String
  fileUrl        String
  fileSize       Int
  extractedText  String? @db.Text

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([conversationId])
}

// ─── Context & Planning models ──────────────────────────

model ConversationSummary {
  id              String @id @default(cuid())
  conversationId  String @unique
  content         String @db.Text
  tokenEstimate   Int    @default(0)
  messagesCovered Int    @default(0)
  version         Int    @default(1)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ConversationPlan {
  id             String  @id @default(cuid())
  conversationId String
  messageId      String?
  content        String  @db.Text
  memory         String? @db.Text
  isActive       Boolean @default(true)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  message      Message?     @relation(fields: [messageId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId, isActive])
}

// ─── Agent models ───────────────────────────────────────

model Agent {
  id           String  @id @default(cuid())
  userId       String?
  name         String
  description  String? @db.Text
  instructions String  @db.Text
  model        String  @default("openai")
  icon         String  @default("Bot")
  iconColor    String  @default("#4F6EF7")
  avatar         String? @db.Text
  starterPrompts String[] @default([])
  isPublic       Boolean @default(false)
  isSystem       Boolean @default(false)
  sortOrder    Int     @default(0)
  status       SkillStatus @default(DRAFT)

  user          User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  files         AgentFile[]
  conversations Conversation[]
  skills        AgentSkill[]
  mcpServers    AgentMcpServer[]
  tools         AgentTool[]
  plugins       AgentPlugin[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, updatedAt])
  @@index([isSystem, sortOrder])
}

model AgentFile {
  id            String  @id @default(cuid())
  agentId       String
  fileName      String
  fileType      String
  fileUrl       String
  fileSize      Int
  extractedText String? @db.Text
  inContext      Boolean @default(true)

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([agentId])
}

// ─── Billing models ─────────────────────────────────────

model Plan {
  id                  String   @id @default(cuid())
  slug                String   @unique
  name                String
  description         String?  @db.Text
  price               String   @default("0")
  messagesPerDay      Int      @default(20)
  tokensPerMessage    Int      @default(4096)
  tokensPerMonth      Int      @default(60000)
  requestsPerMinute   Int      @default(5)
  contextWindowSize   Int      @default(8192)
  maxConversations    Int      @default(10)
  maxAgents           Int      @default(0)
  documentsPerMonth   Int      @default(0)
  canUseAdvancedTools Boolean  @default(false)
  canUseReasoning     Boolean  @default(false)
  canUseRag           Boolean  @default(false)
  canUseGraph         Boolean  @default(false)
  canChooseProvider   Boolean  @default(false)
  isDefault           Boolean  @default(false)
  sortOrder           Int      @default(0)
  highlighted         Boolean  @default(false)
  trialDays           Int      @default(0)
  maxStorageMb        Int      @default(0) // 0 = без лимита

  subscriptions Subscription[]
  planModels    PlanModel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subscription {
  id        String    @id @default(cuid())
  userId    String    @unique
  planId    String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id], onDelete: Restrict)

  grantedBy    String?
  expiresAt    DateTime?
  trialEndsAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planId])
}

model DailyUsage {
  id     String   @id @default(cuid())
  userId String
  date   DateTime @db.Date

  messageCount Int @default(0)
  tokenCount   Int @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

// ─── Skills System ──────────────────────────────────────

model Skill {
  id            String  @id @default(cuid())
  name          String
  description   String? @db.Text
  systemPrompt  String  @db.Text
  templates     Json?
  citationRules String? @db.Text
  jurisdiction  String? @default("RU")
  icon          String  @default("Scale")
  iconColor     String  @default("#4F6EF7")
  isBuiltIn     Boolean     @default(false)
  isPublic      Boolean     @default(false)
  status        SkillStatus @default(DRAFT)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  agents AgentSkill[]
  tools  SkillTool[]
  plugins PluginSkill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isBuiltIn])
}

model AgentSkill {
  id      String @id @default(cuid())
  agentId String
  skillId String

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([agentId, skillId])
}

// ─── Tools & Plugins ───────────────────────────────────

model Tool {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  icon        String   @default("Wrench")
  iconColor   String   @default("#4F6EF7")
  type        ToolType @default(PROMPT_TEMPLATE)
  config      Json     @default("{}")
  inputSchema Json?
  isGlobal    Boolean  @default(false)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  agents  AgentTool[]
  skills  SkillTool[]
  plugins PluginTool[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isGlobal, isActive])
}

model Plugin {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text
  icon        String  @default("Puzzle")
  iconColor   String  @default("#4F6EF7")
  version     String  @default("1.0.0")
  isGlobal    Boolean @default(false)
  isActive    Boolean @default(true)
  sortOrder   Int     @default(0)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  agents     AgentPlugin[]
  mcpServers PluginMcpServer[]
  skills     PluginSkill[]
  tools      PluginTool[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isGlobal, isActive])
}

model AgentTool {
  id      String @id @default(cuid())
  agentId String
  toolId  String

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  tool  Tool  @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@unique([agentId, toolId])
}

model AgentPlugin {
  id       String @id @default(cuid())
  agentId  String
  pluginId String

  agent  Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  plugin Plugin @relation(fields: [pluginId], references: [id], onDelete: Cascade)

  @@unique([agentId, pluginId])
}

model PluginMcpServer {
  id          String @id @default(cuid())
  pluginId    String
  mcpServerId String

  plugin    Plugin    @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  mcpServer McpServer @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)

  @@unique([pluginId, mcpServerId])
}

model PluginSkill {
  id       String @id @default(cuid())
  pluginId String
  skillId  String

  plugin Plugin @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  skill  Skill  @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([pluginId, skillId])
}

model PluginTool {
  id       String @id @default(cuid())
  pluginId String
  toolId   String

  plugin Plugin @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  tool   Tool   @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@unique([pluginId, toolId])
}

model SkillTool {
  id      String @id @default(cuid())
  skillId String
  toolId  String

  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)
  tool  Tool  @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@unique([skillId, toolId])
}

// ─── Persistent Tasks ──────────────────────────────────

model Task {
  id             String     @id @default(cuid())
  userId         String
  conversationId String?
  title          String
  steps          Json
  status         TaskStatus @default(IN_PROGRESS)
  progress       Int        @default(0)

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([conversationId])
}

// ─── Auto Memory ───────────────────────────────────────

model UserMemory {
  id      String  @id @default(cuid())
  userId  String
  key     String
  content String  @db.Text
  source  String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, key])
  @@index([userId])
}

// ─── User Knowledge Files ─────────────────────────────

model UserFile {
  id          String  @id @default(cuid())
  userId      String
  name        String
  description String?
  content     String  @db.Text
  fileType    String  @default("md")
  sizeBytes   Int     @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ─── Conversation Scratchpad ───────────────────────────

model Scratchpad {
  id             String @id @default(cuid())
  conversationId String
  key            String
  content        String @db.Text

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([conversationId, key])
  @@index([conversationId])
}

// ─── MCP models ─────────────────────────────────────────

model McpServer {
  id              String       @id @default(cuid())
  userId          String?
  name            String
  url             String
  transport       McpTransport @default(SSE)
  apiKey          String?      @db.Text
  status               McpStatus    @default(DISCONNECTED)
  discoveredTools      Json?
  isGlobal             Boolean      @default(false)
  isEnabled            Boolean      @default(true)
  lastHealthCheck      DateTime?
  healthCheckInterval  Int          @default(300) // seconds

  user     User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  agents   AgentMcpServer[]
  toolLogs McpToolLog[]
  plugins  PluginMcpServer[]
  userLinks UserMcpServer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isGlobal, isEnabled])
}

model UserMcpServer {
  id          String  @id @default(cuid())
  userId      String
  mcpServerId String
  isActive    Boolean @default(true)

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mcpServer McpServer @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, mcpServerId])
  @@index([userId, isActive])
}

model AgentMcpServer {
  id          String @id @default(cuid())
  agentId     String
  mcpServerId String

  agent     Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  mcpServer McpServer @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)

  @@unique([agentId, mcpServerId])
}

model McpToolLog {
  id          String  @id @default(cuid())
  mcpServerId String
  toolName    String
  input       Json?
  output      Json?
  durationMs  Int?
  success     Boolean @default(true)
  error       String? @db.Text
  userId      String?
  conversationId String?

  mcpServer McpServer @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([mcpServerId, createdAt])
  @@index([toolName, createdAt])
}

// ─── AI Provider & Model models ────────────────────────

enum ApiFormat {
  OPENAI_COMPAT
  AI_SDK_OPENAI
  AI_SDK_ANTHROPIC
}

model AiProvider {
  id        String    @id @default(cuid())
  name      String    @unique
  slug      String    @unique
  baseUrl   String
  apiKey    String    @db.Text
  isActive  Boolean   @default(true)
  priority  Int       @default(0)
  apiFormat ApiFormat  @default(OPENAI_COMPAT)

  models AiModel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AiModel {
  id          String        @id @default(cuid())
  providerId  String
  modelId     String
  displayName String
  category    ModelCategory

  temperature   Float?
  topP          Float?
  maxTokens     Int?
  contextWindow Int?

  costPer1kInput  Float @default(0)
  costPer1kOutput Float @default(0)

  pricePer1kInput  Float @default(0)
  pricePer1kOutput Float @default(0)

  supportsThinking  Boolean @default(false)
  maxThinkingTokens Int?

  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  provider   AiProvider  @relation(fields: [providerId], references: [id], onDelete: Cascade)
  planModels PlanModel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([providerId, modelId])
  @@index([category, isActive])
}

model PlanModel {
  id        String  @id @default(cuid())
  planId    String
  modelId   String
  isDefault Boolean @default(false)

  plan  Plan    @relation(fields: [planId], references: [id], onDelete: Cascade)
  model AiModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@unique([planId, modelId])
}

// ─── Email & Notifications ─────────────────────────────

model EmailLog {
  id       String      @id @default(cuid())
  userId   String?
  to       String
  subject  String
  type     EmailType
  status   EmailStatus @default(PENDING)
  error    String?     @db.Text
  metadata Json?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([type, status])
}

// ─── System Agents ────────────────────────────────────────

/// @deprecated Use Agent with isSystem=true instead. Kept for backward compatibility.
model SystemAgent {
  id             String   @id @default(cuid())
  name           String   @unique
  description    String?  @db.Text
  systemPrompt   String   @db.Text
  icon           String   @default("Bot")
  iconColor      String   @default("#4F6EF7")
  model          String   @default("default")
  starterPrompts String[] @default([])
  isActive       Boolean  @default(true)
  sortOrder      Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Token Logging ────────────────────────────────────────

model TokenLog {
  id             String @id @default(cuid())
  userId         String
  conversationId String?
  provider       String
  model          String
  inputTokens    Int    @default(0)
  outputTokens   Int    @default(0)
  cost           Float  @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([provider, createdAt])
  @@index([createdAt])
}

// ─── Audit Log ────────────────────────────────────────────

model AuditLog {
  id       String @id @default(cuid())
  actorId  String
  action   String
  target   String
  targetId String?
  details  Json?
  ip       String?

  createdAt DateTime @default(now())

  @@index([actorId, createdAt])
  @@index([action, createdAt])
  @@index([target, targetId])
}

// ─── Error Log ────────────────────────────────────────────

model ErrorLog {
  id        String @id @default(cuid())
  route     String
  method    String
  message   String @db.Text
  stack     String? @db.Text
  userId    String?
  metadata  Json?

  createdAt DateTime @default(now())

  @@index([route, createdAt])
  @@index([createdAt])
}

// ─── System Notifications ─────────────────────────────────

model Notification {
  id      String           @id @default(cuid())
  userId  String?
  type    NotificationType
  title   String
  message String           @db.Text
  isRead  Boolean          @default(false)
  isGlobal Boolean         @default(false)

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([isGlobal, createdAt])
}

// ─── System Settings ──────────────────────────────────────

model SystemSetting {
  id    String @id @default(cuid())
  key   String @unique
  value String @db.Text
  type  String @default("string")

  updatedAt DateTime @updatedAt
}

// ─── Document Templates ───────────────────────────────────

model DocumentTemplate {
  id           String  @id @default(cuid())
  name         String
  type         String
  content      String  @db.Text
  jurisdiction String  @default("RU")
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type, jurisdiction])
}

// ─── API Keys ─────────────────────────────────────────────

model ApiKey {
  id        String    @id @default(cuid())
  userId    String
  name      String
  key       String    @unique
  keyHash   String?   @unique // SHA-256 hash for secure lookup
  keyPrefix String?   // First 12 chars for display (e.g. "lma_abc12345")
  lastUsed  DateTime?
  expiresAt DateTime?
  isActive  Boolean   @default(true)
  rateLimit Int       @default(60) // requests per minute

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([key])
  @@index([keyHash])
}

// ─── Webhooks ─────────────────────────────────────────────

model Webhook {
  id       String   @id @default(cuid())
  url      String
  events   String[]
  secret   String
  isActive Boolean  @default(true)

  logs WebhookLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WebhookLog {
  id         String @id @default(cuid())
  webhookId  String
  event      String
  payload    Json?
  statusCode Int?
  response   String? @db.Text
  success    Boolean @default(false)
  attempt    Int     @default(1)
  error      String? @db.Text

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([webhookId, createdAt])
  @@index([event, createdAt])
}

// ─── Payments ────────────────────────────────────────────

model Payment {
  id              String        @id @default(cuid())
  userId          String
  subscriptionId  String?
  amount          Int           // in minor units (tiyn)
  currency        String        @default("KZT")
  status          PaymentStatus @default(PENDING)
  provider        String        @default("manual") // manual | stripe
  externalId      String?       // Stripe payment intent ID
  metadata        Json?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([status])
}

model PromoCode {
  id          String    @id @default(cuid())
  code        String    @unique
  description String?
  discount    Int       @default(0)  // percent discount (0-100)
  maxUses     Int       @default(0)  // 0 = unlimited
  usedCount   Int       @default(0)
  validFrom   DateTime  @default(now())
  validUntil  DateTime?
  isActive    Boolean   @default(true)
  planId      String?   // restrict to specific plan

  createdAt DateTime @default(now())

  @@index([code])
}

// ─── Email Templates ────────────────────────────────────

model EmailTemplate {
  id       String    @id @default(cuid())
  type     EmailType @unique
  subject  String
  html     String    @db.Text
  isActive Boolean   @default(true)

  updatedAt DateTime @updatedAt
}

// ─── Prompt Versioning ───────────────────────────────────

model PromptVersion {
  id        String @id @default(cuid())
  key       String
  content   String @db.Text
  version   Int    @default(1)
  authorId  String
  changelog String?

  createdAt DateTime @default(now())

  @@index([key, version])
}

// ─── File Uploads ───────────────────────────────────────

model FileUpload {
  id          String @id @default(cuid())
  userId      String
  fileName    String
  fileSize    Int
  mimeType    String
  storageKey  String // S3 key
  storageUrl  String? // public URL if applicable

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
}

// ─── A/B Prompt Experiments ──────────────────────────────

model PromptExperiment {
  id          String   @id @default(cuid())
  name        String
  description String?
  key         String   // which prompt to test (e.g. "global_system_prompt")
  isActive    Boolean  @default(true)
  trafficPct  Int      @default(50) // % of users that get variant B

  variantA    String   @db.Text // control
  variantB    String   @db.Text // experiment

  // Metrics
  impressionsA Int @default(0)
  impressionsB Int @default(0)
  avgRatingA   Float @default(0)
  avgRatingB   Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Content Reports (agent/skill complaints) ────────────

model ContentReport {
  id         String @id @default(cuid())
  reporterId String
  targetType String // "agent" | "skill"
  targetId   String
  reason     String @db.Text
  status     ReportStatus @default(PENDING)
  resolvedBy String?
  resolution String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([targetType, targetId])
  @@index([status])
}

enum ReportStatus {
  PENDING
  REVIEWED
  ACTION_TAKEN
  DISMISSED
}

// ─── Enums ───────────────────────────────────────────────

enum UserRole {
  USER
  PRO
  ADMIN
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

enum ArtifactType {
  CONTRACT
  CLAIM
  COMPLAINT
  DOCUMENT
  CODE
  ANALYSIS
}

enum TaskStatus {
  IN_PROGRESS
  COMPLETED
  PAUSED
  FAILED
}

enum McpTransport {
  SSE
  STREAMABLE_HTTP
}

enum McpStatus {
  CONNECTED
  DISCONNECTED
  ERROR
}

enum ModelCategory {
  TEXT
  IMAGE
  VOICE
  VIDEO
  CODE
  EMBEDDING
}

enum EmailType {
  WELCOME
  INVOICE
  SUBSCRIPTION_EXPIRING
  PAYMENT_FAILED
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum SkillStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum ToolType {
  PROMPT_TEMPLATE
  WEBHOOK
  URL
  FUNCTION
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  MAINTENANCE
  UPDATE
  BILLING
}
