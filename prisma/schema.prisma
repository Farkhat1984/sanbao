generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// ─── NextAuth models ─────────────────────────────────────

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── App models ──────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          UserRole  @default(USER)

  accounts      Account[]
  sessions      Session[]
  conversations Conversation[]
  subscription  Subscription?
  dailyUsage    DailyUsage[]
  agents        Agent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Conversation {
  id       String  @id @default(cuid())
  title    String  @default("Новый чат")
  userId   String
  pinned   Boolean @default(false)
  archived Boolean @default(false)
  agentId  String?

  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent       Agent?                @relation(fields: [agentId], references: [id], onDelete: SetNull)
  messages    Message[]
  artifacts   Artifact[]
  attachments Attachment[]
  summary     ConversationSummary?
  plans       ConversationPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, updatedAt])
  @@index([agentId])
}

model Message {
  id             String      @id @default(cuid())
  conversationId String
  role           MessageRole
  content        String      @db.Text
  toolName       String?
  toolResult     Json?
  planContent    String?     @db.Text

  conversation Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  legalRefs    LegalReference[]
  artifacts    Artifact[]
  plans        ConversationPlan[]

  createdAt DateTime @default(now())

  @@index([conversationId, createdAt])
}

model Artifact {
  id             String       @id @default(cuid())
  conversationId String
  messageId      String?
  type           ArtifactType
  title          String
  content        String       @db.Text
  version        Int          @default(1)
  metadata       Json?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  message      Message?     @relation(fields: [messageId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId])
}

model LegalReference {
  id           String  @id @default(cuid())
  messageId    String
  articleCode  String
  articleTitle String
  articleText  String  @db.Text
  sourceUrl    String?
  isActual     Boolean @default(true)

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([articleCode])
}

model Attachment {
  id             String @id @default(cuid())
  conversationId String
  fileName       String
  fileType       String
  fileUrl        String
  fileSize       Int
  extractedText  String? @db.Text

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([conversationId])
}

// ─── Context & Planning models ──────────────────────────

model ConversationSummary {
  id              String @id @default(cuid())
  conversationId  String @unique
  content         String @db.Text
  tokenEstimate   Int    @default(0)
  messagesCovered Int    @default(0)
  version         Int    @default(1)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ConversationPlan {
  id             String  @id @default(cuid())
  conversationId String
  messageId      String?
  content        String  @db.Text
  memory         String? @db.Text
  isActive       Boolean @default(true)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  message      Message?     @relation(fields: [messageId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId, isActive])
}

// ─── Agent models ───────────────────────────────────────

model Agent {
  id           String  @id @default(cuid())
  userId       String
  name         String
  description  String? @db.Text
  instructions String  @db.Text
  model        String  @default("openai")
  icon         String  @default("Bot")
  iconColor    String  @default("#4F6EF7")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  files         AgentFile[]
  conversations Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, updatedAt])
}

model AgentFile {
  id            String  @id @default(cuid())
  agentId       String
  fileName      String
  fileType      String
  fileUrl       String
  fileSize      Int
  extractedText String? @db.Text

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([agentId])
}

// ─── Billing models ─────────────────────────────────────

model Plan {
  id                  String   @id @default(cuid())
  slug                String   @unique
  name                String
  description         String?  @db.Text
  price               String   @default("0")
  messagesPerDay      Int      @default(20)
  tokensPerMessage    Int      @default(4096)
  tokensPerMonth      Int      @default(60000)
  requestsPerMinute   Int      @default(5)
  contextWindowSize   Int      @default(8192)
  maxConversations    Int      @default(10)
  maxAgents           Int      @default(0)
  documentsPerMonth   Int      @default(0)
  canUseAdvancedTools Boolean  @default(false)
  canUseReasoning     Boolean  @default(false)
  canUseRag           Boolean  @default(false)
  canUseGraph         Boolean  @default(false)
  canChooseProvider   Boolean  @default(false)
  isDefault           Boolean  @default(false)
  sortOrder           Int      @default(0)
  highlighted         Boolean  @default(false)

  subscriptions Subscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subscription {
  id        String    @id @default(cuid())
  userId    String    @unique
  planId    String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id])

  grantedBy String?
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planId])
}

model DailyUsage {
  id     String   @id @default(cuid())
  userId String
  date   DateTime @db.Date

  messageCount Int @default(0)
  tokenCount   Int @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

// ─── Enums ───────────────────────────────────────────────

enum UserRole {
  USER
  PRO
  ADMIN
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

enum ArtifactType {
  CONTRACT
  CLAIM
  COMPLAINT
  DOCUMENT
  CODE
  ANALYSIS
}
