# Daily PostgreSQL backup at 03:00 UTC
apiVersion: batch/v1
kind: CronJob
metadata:
  name: sanbao-pg-backup
  namespace: sanbao
spec:
  schedule: "0 3 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 5
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          labels:
            app: sanbao-backup
        spec:
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: postgres:16-alpine
              command: ["/bin/sh", "/scripts/pg-backup.sh"]
              env:
                - name: PGHOST
                  value: "postgres"
                - name: PGUSER
                  value: "postgres"
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: sanbao-secrets
                      key: DB_PASSWORD
                - name: PGDATABASE
                  value: "sanbao"
                - name: S3_BUCKET
                  valueFrom:
                    secretKeyRef:
                      name: sanbao-secrets
                      key: S3_BACKUP_BUCKET
                      optional: true
                - name: S3_ENDPOINT
                  valueFrom:
                    secretKeyRef:
                      name: sanbao-secrets
                      key: S3_ENDPOINT
                      optional: true
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: sanbao-secrets
                      key: S3_ACCESS_KEY
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: sanbao-secrets
                      key: S3_SECRET_KEY
              volumeMounts:
                - name: scripts
                  mountPath: /scripts
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
          volumes:
            - name: scripts
              configMap:
                name: backup-script
                defaultMode: 0755
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-script
  namespace: sanbao
data:
  pg-backup.sh: |
    #!/bin/sh
    set -e
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    FILENAME="sanbao-backup-${TIMESTAMP}.sql.gz"
    LOCAL_PATH="/tmp/${FILENAME}"
    echo "[backup] Starting PostgreSQL backup at ${TIMESTAMP}"
    apk add --no-cache aws-cli > /dev/null 2>&1
    pg_dump -h "$PGHOST" -U "$PGUSER" -d "$PGDATABASE" \
      --no-owner --no-privileges --clean --if-exists | gzip > "$LOCAL_PATH"
    SIZE=$(du -h "$LOCAL_PATH" | cut -f1)
    echo "[backup] Dump complete: ${FILENAME} (${SIZE})"
    S3_URI="s3://${S3_BUCKET}/backups/postgres/${FILENAME}"
    if [ -n "$S3_ENDPOINT" ]; then
      aws s3 cp "$LOCAL_PATH" "$S3_URI" --endpoint-url "$S3_ENDPOINT"
    else
      aws s3 cp "$LOCAL_PATH" "$S3_URI"
    fi
    echo "[backup] Uploaded to ${S3_URI}"
    rm -f "$LOCAL_PATH"
    echo "[backup] Done."
