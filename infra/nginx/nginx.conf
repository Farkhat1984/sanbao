upstream sanbao_app {
    least_conn;
    server app:3004 max_fails=3 fail_timeout=30s;
    # When scaling: docker compose up --scale app=3
    # All replicas register under "app" hostname automatically
}

# Connection limiting zones
limit_conn_zone $binary_remote_addr zone=conn_per_ip:10m;
limit_req_zone $binary_remote_addr zone=req_per_ip:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=api_chat:10m rate=10r/s;

server {
    listen 80;
    server_name _;
    server_tokens off;

    # Security headers
    # NOTE: These 5 headers are also set by Next.js in next.config.ts.
    # They are intentionally kept here for non-Next.js locations (e.g. /images/1c/ proxy,
    # /api/metrics internal endpoint) that bypass Next.js response headers.
    # Next.js additionally sets: X-DNS-Prefetch-Control, Permissions-Policy, Content-Security-Policy.
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # Limits
    client_max_body_size 20m;
    client_body_timeout 30s;
    client_header_timeout 15s;
    send_timeout 60s;

    # Connection limits
    limit_conn conn_per_ip 50;

    # Gzip
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml;
    gzip_min_length 256;

    # Retry on backend failures (only for idempotent GET/HEAD requests)
    proxy_next_upstream error timeout http_502 http_503 non_idempotent=off;
    proxy_next_upstream_tries 1;

    # Health check endpoint (no rate limiting)
    location /api/health {
        proxy_pass http://sanbao_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    # Metrics endpoint (no rate limiting, internal only)
    location /api/metrics {
        # Restrict to internal networks
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        allow 127.0.0.1;
        deny all;

        proxy_pass http://sanbao_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Chat endpoint — stricter rate limit, long timeout for SSE
    location /api/chat {
        limit_req zone=api_chat burst=5 nodelay;

        proxy_pass http://sanbao_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Connection '';
        proxy_http_version 1.1;

        # SSE support — extended timeout for tool calling loops
        proxy_read_timeout 180s;
        proxy_buffering off;
        chunked_transfer_encoding on;
    }

    # 1C article images — proxy to AI Cortex orchestrator
    # Note: add_header in location blocks replaces server-level headers,
    # so security headers must be re-declared here.
    location /images/1c/ {
        proxy_pass http://orchestrator:8120/images/1c/;
        proxy_set_header Host $host;
        proxy_cache_valid 200 30d;
        add_header Cache-Control "public, max-age=2592000, immutable" always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-Frame-Options DENY always;
        add_header Referrer-Policy strict-origin-when-cross-origin always;
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
        expires 30d;
    }

    # Static assets — long cache only on success, no-cache on errors
    location /_next/static {
        proxy_pass http://sanbao_app;
        proxy_intercept_errors on;

        # Cache headers only for successful responses
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        # Note: Nginx add_header in a location block replaces (not merges with) server-level
        # headers, so security headers must be re-declared alongside Cache-Control.
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy strict-origin-when-cross-origin always;
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        # Tell Cloudflare not to cache error responses
        error_page 500 502 503 504 = @static_error;
    }

    location @static_error {
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;
        add_header CDN-Cache-Control "no-store" always;
        add_header Cloudflare-CDN-Cache-Control "no-store" always;
        return 503;
    }

    # All other routes
    location / {
        limit_req zone=req_per_ip burst=50 nodelay;

        proxy_pass http://sanbao_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_read_timeout 60s;
    }
}
